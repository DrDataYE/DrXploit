#!/bin/bash

set -euo pipefail

resolve_link() {
  local target="$1"
  if command -v readlink >/dev/null 2>&1; then
    readlink "$target"
  else
    return 1
  fi
}

SCRIPT_PATH="$0"
if [ -L "$SCRIPT_PATH" ]; then
  while true; do
    local_target="$(resolve_link "$SCRIPT_PATH" 2>/dev/null || true)"
    if [ -z "$local_target" ]; then
      break
    fi
    if [[ "$local_target" != /* ]]; then
      SCRIPT_PATH="$(cd "$(dirname "$SCRIPT_PATH")" && cd "$(dirname "$local_target")" && pwd)/$(basename "$local_target")"
    else
      SCRIPT_PATH="$local_target"
    fi
    if [ ! -L "$SCRIPT_PATH" ]; then
      break
    fi
  done
fi

SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
BASE_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
INSTALL_DIR="$BASE_DIR/opt/drxploit"

if [ ! -d "$INSTALL_DIR" ]; then
  echo "DrXploit installation not found in $INSTALL_DIR" >&2
  exit 1
fi

VENV_PATH_FILE="$INSTALL_DIR/.venv_path"
if [ -f "$VENV_PATH_FILE" ]; then
  IFS= read -r VENV_DIR < "$VENV_PATH_FILE"
else
  VENV_DIR="$INSTALL_DIR/.venv"
fi

if [ -z "$VENV_DIR" ]; then
  VENV_DIR="$INSTALL_DIR/.venv"
fi

if [ -d "$VENV_DIR" ]; then
  if command -v readlink >/dev/null 2>&1 && readlink -f "$VENV_DIR" >/dev/null 2>&1; then
    VENV_DIR="$(readlink -f "$VENV_DIR")"
  elif command -v realpath >/dev/null 2>&1; then
    VENV_DIR="$(realpath "$VENV_DIR")"
  fi
fi

PYTHON_BIN="$VENV_DIR/bin/python3"
if [ ! -x "$PYTHON_BIN" ]; then
  PYTHON_BIN="$VENV_DIR/bin/python"
fi
if [ ! -x "$PYTHON_BIN" ]; then
  PYTHON_BIN="$(command -v python3 || command -v python || true)"
fi

if [ -z "$PYTHON_BIN" ]; then
  echo "Python interpreter not found." >&2
  exit 1
fi

ARGS=()

if [ "$#" -gt 0 ]; then
  FIRST_ARG="$1"
  shift
  if [ -f "$FIRST_ARG" ]; then
    if command -v readlink >/dev/null 2>&1 && readlink -f "$FIRST_ARG" >/dev/null 2>&1; then
      FIRST_ARG="$(readlink -f "$FIRST_ARG")"
    elif command -v realpath >/dev/null 2>&1; then
      FIRST_ARG="$(realpath "$FIRST_ARG")"
    fi
  fi
  ARGS=("$FIRST_ARG" "$@")
else
  ARGS=("$@")
fi

cd "$INSTALL_DIR"
exec "$PYTHON_BIN" -B main.py "${ARGS[@]}"

